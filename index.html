<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‚¬ì—… ì‹¤ì  ì…ë ¥ ì‹œìŠ¤í…œ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6',
                        secondary: '#10b981',
                    }
                }
            }
        }
    </script>
    <style>
        /* === GLASSMORPHISM BASE === */
        body {
            background: #ffffff;
            position: relative;
            overflow-x: hidden;
        }

        /* Decorative gradient blobs for glass effect */
        body::before,
        body::after {
            content: '';
            position: fixed;
            border-radius: 50%;
            filter: blur(80px);
            opacity: 0.4;
            z-index: -1;
        }

        body::before {
            width: 300px;
            height: 300px;
            background: linear-gradient(135deg, #60a5fa, #a78bfa);
            top: -80px;
            left: -60px;
        }

        body::after {
            width: 350px;
            height: 350px;
            background: linear-gradient(135deg, #34d399, #60a5fa);
            bottom: -100px;
            right: -80px;
        }

        /* Glass Card */
        .glass {
            background: rgba(255, 255, 255, 0.55);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.7);
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.08);
        }

        /* Glass Card (darker variant for modals) */
        .glass-strong {
            background: rgba(255, 255, 255, 0.75);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.85);
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.12);
        }

        /* Buttons */
        .btn-glass {
            transition: all 0.2s ease;
        }

        .btn-glass:active {
            transform: scale(0.97);
        }

        /* Custom Tailwind overrides */
        .btn-large {
            @apply w-full py-4 rounded-xl text-lg font-semibold shadow-md transition transform active:scale-95;
        }

        .input-field {
            @apply w-full p-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-400 focus:border-transparent outline-none bg-white/60 backdrop-blur-sm;
        }

        /* Hide scrollbar */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Subtle float animation for decorative elements */
        @keyframes float {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-8px);
            }
        }

        .float-anim {
            animation: float 6s ease-in-out infinite;
        }
    </style>
</head>

<body class="text-gray-800 font-sans antialiased min-h-screen">

    <!-- Extra decorative blobs -->
    <div
        class="fixed top-1/3 right-0 w-64 h-64 rounded-full bg-gradient-to-br from-purple-200 to-pink-200 opacity-30 blur-3xl -z-10 float-anim">
    </div>
    <div class="fixed bottom-1/4 left-0 w-48 h-48 rounded-full bg-gradient-to-br from-emerald-200 to-cyan-200 opacity-30 blur-3xl -z-10 float-anim"
        style="animation-delay: -3s;"></div>

    <!-- Loading Overlay -->
    <div id="loading" class="fixed inset-0 bg-white/80 backdrop-blur-sm z-50 flex items-center justify-center hidden">
        <div class="flex flex-col items-center space-y-3">
            <div class="animate-spin rounded-full h-12 w-12 border-t-4 border-blue-500"></div>
            <span class="text-sm text-gray-500">ì²˜ë¦¬ ì¤‘...</span>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed top-6 left-1/2 -translate-x-1/2 z-50 hidden">
        <div
            class="glass-strong px-6 py-3 rounded-xl shadow-lg text-sm font-medium text-gray-700 flex items-center space-x-2">
            <span id="toast-icon">âœ“</span>
            <span id="toast-msg">ì™„ë£Œ</span>
        </div>
    </div>

    <!-- Container -->
    <div class="max-w-md mx-auto min-h-screen flex flex-col relative">

        <!-- ==================== LOGIN SCREEN ==================== -->
        <div id="login-screen" class="flex-1 flex flex-col justify-center p-6 space-y-6">
            <div class="text-center">
                <div class="text-5xl mb-3 float-anim">ğŸ“Š</div>
                <h1 class="text-3xl font-extrabold text-gray-900 mb-1">ì‚¬ì—… ì‹¤ì  ì…ë ¥</h1>
                <p class="text-gray-500 text-sm">ë‹´ë‹¹ì ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”</p>
            </div>

            <div class="glass rounded-2xl p-6 space-y-4">
                <div>
                    <label class="block text-xs font-semibold text-gray-600 mb-1 uppercase tracking-wide">ì´ë¦„</label>
                    <input type="text" id="login-name" class="input-field" placeholder="í™ê¸¸ë™">
                </div>
                <div>
                    <label class="block text-xs font-semibold text-gray-600 mb-1 uppercase tracking-wide">íŒ€ëª…</label>
                    <select id="login-team" class="input-field">
                        <option value="ê±´ê°•ë¬¸í™”íŒ€">ê±´ê°•ë¬¸í™”íŒ€</option>
                        <option value="ì§€ì—­ë³µì§€íŒ€">ì§€ì—­ë³µì§€íŒ€</option>
                        <option value="ë§ì¶¤ì§€ì›íŒ€">ë§ì¶¤ì§€ì›íŒ€</option>
                        <option value="ì„±ì¥ì§€ì›íŒ€">ì„±ì¥ì§€ì›íŒ€</option>
                        <option value="ì „ëµê¸°íšíŒ€">ì „ëµê¸°íšíŒ€</option>
                        <option value="ë¯¸ë˜ê²½ì˜íŒ€">ë¯¸ë˜ê²½ì˜íŒ€</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-semibold text-gray-600 mb-1 uppercase tracking-wide">ë¹„ë°€ë²ˆí˜¸</label>
                    <input type="password" id="login-password" class="input-field" placeholder="â€¢â€¢â€¢â€¢"
                        onkeydown="if(event.key==='Enter') handleLogin()">
                </div>
                <button onclick="handleLogin()"
                    class="btn-large bg-gradient-to-r from-blue-500 to-indigo-500 text-white hover:from-blue-600 hover:to-indigo-600 mt-2 btn-glass">
                    ë¡œê·¸ì¸
                </button>
                <p class="text-center text-sm text-gray-500">
                    ê³„ì •ì´ ì—†ìœ¼ì‹ ê°€ìš”? <a href="#" onclick="toggleScreen('signup-screen')"
                        class="text-blue-500 font-semibold hover:underline">íšŒì›ê°€ì…</a>
                </p>
            </div>
        </div>

        <!-- ==================== SIGNUP SCREEN ==================== -->
        <div id="signup-screen" class="hidden flex-1 flex flex-col justify-center p-6 space-y-6">
            <div class="text-center">
                <div class="text-5xl mb-3 float-anim">âœï¸</div>
                <h1 class="text-3xl font-extrabold text-gray-900 mb-1">íšŒì›ê°€ì…</h1>
                <p class="text-gray-500 text-sm">ìƒˆ ê³„ì •ì„ ë“±ë¡í•©ë‹ˆë‹¤</p>
            </div>

            <div class="glass rounded-2xl p-6 space-y-4">
                <div>
                    <label class="block text-xs font-semibold text-gray-600 mb-1 uppercase tracking-wide">ì´ë¦„</label>
                    <input type="text" id="signup-name" class="input-field" placeholder="í™ê¸¸ë™">
                </div>
                <div>
                    <label class="block text-xs font-semibold text-gray-600 mb-1 uppercase tracking-wide">íŒ€ëª…</label>
                    <select id="signup-team" class="input-field">
                        <option value="ê±´ê°•ë¬¸í™”íŒ€">ê±´ê°•ë¬¸í™”íŒ€</option>
                        <option value="ì§€ì—­ë³µì§€íŒ€">ì§€ì—­ë³µì§€íŒ€</option>
                        <option value="ë§ì¶¤ì§€ì›íŒ€">ë§ì¶¤ì§€ì›íŒ€</option>
                        <option value="ì„±ì¥ì§€ì›íŒ€">ì„±ì¥ì§€ì›íŒ€</option>
                        <option value="ì „ëµê¸°íšíŒ€">ì „ëµê¸°íšíŒ€</option>
                        <option value="ë¯¸ë˜ê²½ì˜íŒ€">ë¯¸ë˜ê²½ì˜íŒ€</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-semibold text-gray-600 mb-1 uppercase tracking-wide">ì§ê¸‰</label>
                    <input type="text" id="signup-position" class="input-field" placeholder="ì‚¬íšŒë³µì§€ì‚¬">
                </div>
                <div>
                    <label class="block text-xs font-semibold text-gray-600 mb-1 uppercase tracking-wide">ë¹„ë°€ë²ˆí˜¸</label>
                    <input type="password" id="signup-password" class="input-field" placeholder="4ìë¦¬ ì´ìƒ">
                </div>
                <div>
                    <label class="block text-xs font-semibold text-gray-600 mb-1 uppercase tracking-wide">ë¹„ë°€ë²ˆí˜¸
                        í™•ì¸</label>
                    <input type="password" id="signup-password-confirm" class="input-field" placeholder="ë¹„ë°€ë²ˆí˜¸ ì¬ì…ë ¥"
                        onkeydown="if(event.key==='Enter') handleSignup()">
                </div>
                <button onclick="handleSignup()"
                    class="btn-large bg-gradient-to-r from-emerald-500 to-teal-500 text-white hover:from-emerald-600 hover:to-teal-600 mt-2 btn-glass">
                    ê°€ì…í•˜ê¸°
                </button>
                <p class="text-center text-sm text-gray-500">
                    ì´ë¯¸ ê³„ì •ì´ ìˆë‚˜ìš”? <a href="#" onclick="toggleScreen('login-screen')"
                        class="text-blue-500 font-semibold hover:underline">ë¡œê·¸ì¸</a>
                </p>
            </div>
        </div>

        <!-- ==================== DASHBOARD SCREEN ==================== -->
        <div id="dashboard-screen" class="hidden flex-1 flex flex-col">
            <!-- Header -->
            <header
                class="glass-strong px-6 py-4 flex justify-between items-center sticky top-0 z-10 border-b border-white/50">
                <div>
                    <h2 class="text-lg font-bold text-gray-900" id="user-display">í™ê¸¸ë™ (ê±´ê°•ë¬¸í™”íŒ€)</h2>
                    <p class="text-xs text-gray-400" id="date-display">2024. 02. 10</p>
                </div>
                <div class="flex items-center space-x-3">
                    <button onclick="toggleAdmin(true)"
                        class="text-sm text-blue-500 hover:text-blue-700 font-semibold btn-glass">ê´€ë¦¬</button>
                    <button onclick="logout()" class="text-sm text-gray-400 hover:text-red-500 btn-glass">ë¡œê·¸ì•„ì›ƒ</button>
                </div>
            </header>

            <!-- Main Content -->
            <main class="flex-1 p-4 pb-24 space-y-4 overflow-y-auto no-scrollbar">

                <!-- Date Picker -->
                <div class="glass rounded-2xl py-3 px-5 flex items-center justify-between">
                    <span class="text-gray-600 font-medium text-sm">ğŸ“… ì‹¤ì  ì¼ì</span>
                    <input type="date" id="record-date"
                        class="bg-white/50 border border-gray-200 rounded-lg px-3 py-1.5 text-sm backdrop-blur-sm">
                </div>

                <!-- Program Selection -->
                <div class="glass rounded-2xl p-5 space-y-2">
                    <label class="text-xs font-semibold text-gray-600 uppercase tracking-wide">í”„ë¡œê·¸ë¨ ì„ íƒ</label>
                    <select id="program-select" class="input-field" onchange="loadProgramData()">
                        <option value="">í”„ë¡œê·¸ë¨ì„ ì„ íƒí•˜ì„¸ìš”</option>
                    </select>
                </div>

                <!-- Input Mode Tabs -->
                <div class="flex space-x-2 bg-white/40 backdrop-blur-sm p-1 rounded-xl border border-white/60">
                    <button onclick="switchTab('attendance')" id="tab-attendance"
                        class="flex-1 py-2.5 rounded-lg text-sm font-semibold bg-white shadow-sm text-blue-600 transition btn-glass">
                        ì¶œì„ë¶€ (ëª…ë‹¨)
                    </button>
                    <button onclick="switchTab('individual')" id="tab-individual"
                        class="flex-1 py-2.5 rounded-lg text-sm font-semibold text-gray-500 hover:bg-white/50 transition btn-glass">
                        ê°œë³„ ë“±ë¡ (ì§ì ‘)
                    </button>
                </div>

                <!-- Attendance View -->
                <div id="view-attendance" class="space-y-3">
                    <div class="relative">
                        <input type="text" id="user-search" placeholder="ì´ìš©ì ê²€ìƒ‰..." class="input-field pl-10"
                            onkeyup="filterUsers()">
                        <svg class="w-5 h-5 text-gray-400 absolute left-3 top-3.5" fill="none" stroke="currentColor"
                            viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                    </div>
                    <div id="user-list" class="space-y-2">
                        <!-- Dynamic User Items -->
                    </div>
                </div>

                <!-- Individual View -->
                <div id="view-individual" class="hidden space-y-4">
                    <div class="glass rounded-2xl p-5 space-y-3">
                        <label class="block text-xs font-semibold text-gray-600 uppercase tracking-wide">ì´ìš©ì ì •ë³´ ì§ì ‘
                            ì…ë ¥</label>
                        <input type="text" id="manual-name" class="input-field" placeholder="ì´ë¦„ (ì˜ˆ: ì´ì˜í¬)">
                        <textarea id="manual-note" class="input-field" rows="3" placeholder="í™œë™ ë‚´ìš© / ë¹„ê³ "></textarea>
                        <button onclick="addManualEntry()"
                            class="w-full py-2.5 bg-white/60 backdrop-blur-sm text-gray-700 rounded-xl hover:bg-white/80 font-medium border border-gray-200 btn-glass">
                            + ëª©ë¡ì— ì¶”ê°€
                        </button>
                    </div>
                    <div id="manual-list" class="space-y-2"></div>
                </div>

            </main>

            <!-- Bottom Action Bar -->
            <div class="fixed bottom-0 left-0 right-0 p-4 max-w-md mx-auto">
                <button onclick="submitData()"
                    class="btn-large bg-gradient-to-r from-emerald-500 to-teal-500 text-white hover:from-emerald-600 hover:to-teal-600 shadow-lg flex items-center justify-center space-x-2 btn-glass">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                    <span>ì‹¤ì  ì €ì¥í•˜ê¸°</span>
                </button>
            </div>
        </div>

        <!-- ==================== ADMIN MODAL ==================== -->
        <div id="admin-modal"
            class="fixed inset-0 bg-black/30 backdrop-blur-sm z-40 hidden flex items-center justify-center p-4">
            <div class="glass-strong rounded-2xl w-full max-w-sm p-6 space-y-4">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-bold text-gray-900">ì´ìš©ì ëª…ë‹¨ ê´€ë¦¬</h3>
                    <button onclick="toggleAdmin(false)"
                        class="text-gray-400 hover:text-gray-700 text-xl btn-glass">âœ•</button>
                </div>

                <div class="space-y-2">
                    <h4 class="font-semibold text-gray-700 text-sm">CSV ì¼ê´„ ì—…ë¡œë“œ</h4>
                    <p class="text-xs text-gray-500">ì§€ì •ëœ ì–‘ì‹ì˜ CSV íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</p>
                    <input type="file" id="csv-file" accept=".csv"
                        class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                </div>

                <div
                    class="p-3 bg-white/50 backdrop-blur-sm rounded-xl text-xs text-gray-500 space-y-1 border border-gray-100">
                    <p>CSV ìˆœì„œ: ì´ë¦„, ìƒë…„ì›”ì¼, ì„±ë³„, ì—°ë½ì²˜, ì¥ì• ìœ í˜•, ì¥ì• ì •ë„</p>
                    <a href="#" onclick="downloadTemplate()" class="text-blue-600 underline font-medium">ğŸ“ í…œí”Œë¦¿ ë‹¤ìš´ë¡œë“œ</a>
                </div>

                <button onclick="processCSV()"
                    class="w-full py-3 bg-gradient-to-r from-blue-500 to-indigo-500 text-white rounded-xl font-bold hover:from-blue-600 hover:to-indigo-600 btn-glass">
                    ì—…ë¡œë“œ ì‹œì‘
                </button>
            </div>
        </div>

    </div>

    <!-- ==================== JAVASCRIPT ==================== -->
    <script>
        // CONFIGURATION
        const API_URL = 'https://script.google.com/macros/s/AKfycbxz0SKLih0A6Z-msGotOvcwa7RXdkk8bGO_hVMA4BlZC4FvaxFWpYA6CGlVxUQFQWRt/exec';

        // STATE
        let currentUser = null;
        let allUsers = [];
        let manualEntries = [];
        let selectedUserIds = new Set();

        /**
         * API í˜¸ì¶œ ë˜í¼ â€” GAS ë¦¬ë””ë ‰íŠ¸ ì‘ë‹µ ë° ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ì²˜ë¦¬
         */
        async function apiCall(url, options = {}) {
            const resp = await fetch(url, { redirect: 'follow', ...options });
            const text = await resp.text();
            try {
                return JSON.parse(text);
            } catch {
                // GASê°€ HTML ì—ëŸ¬ í˜ì´ì§€ë¥¼ ë°˜í™˜í•œ ê²½ìš°
                if (text.includes('<!DOCTYPE')) {
                    throw new Error('ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜ â€” Apps Script ì¬ë°°í¬ê°€ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                }
                throw new Error('ì„œë²„ ì‘ë‹µì„ íŒŒì‹±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ' + text.substring(0, 100));
            }
        }

        // --- TOAST ---
        function showToast(msg, icon = 'âœ“') {
            const toast = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = msg;
            document.getElementById('toast-icon').innerText = icon;
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), 2500);
        }

        // --- AUTHENTICATION ---
        async function handleLogin() {
            const name = document.getElementById('login-name').value.trim();
            const team = document.getElementById('login-team').value;
            const password = document.getElementById('login-password').value;

            if (!name || !password) return alert('ì´ë¦„ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');

            showLoading(true);
            try {
                const data = await apiCall(API_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'login', name, team, password })
                });

                if (data.status === 'success') {
                    currentUser = { name, team, ...data.data };

                    // Fetch users list
                    try {
                        const usersData = await apiCall(`${API_URL}?action=get_users&token=${name}`);
                        if (usersData.status === 'success') {
                            allUsers = (usersData.data || []).map(u => ({
                                id: u.id || '', name: u.name || '', info: u.disability || ''
                            }));
                        }
                    } catch (e) {
                        console.warn('Failed to fetch users, using empty list', e);
                        allUsers = [];
                    }

                    document.getElementById('user-display').innerText = `${name} (${team})`;
                    document.getElementById('record-date').valueAsDate = new Date();
                    document.getElementById('date-display').innerText = new Date().toLocaleDateString('ko-KR');

                    renderPrograms(currentUser.programs || []);
                    renderUserList(allUsers);
                    toggleScreen('dashboard-screen');
                    showToast('ë¡œê·¸ì¸ ì„±ê³µ');
                } else {
                    alert('ë¡œê·¸ì¸ ì‹¤íŒ¨: ' + (data.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                }
            } catch (e) {
                console.error(e);
                alert('ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n' + e.message);
            } finally {
                showLoading(false);
            }
        }

        // --- SIGNUP ---
        async function handleSignup() {
            const name = document.getElementById('signup-name').value.trim();
            const team = document.getElementById('signup-team').value;
            const position = document.getElementById('signup-position').value.trim();
            const password = document.getElementById('signup-password').value;
            const confirmPw = document.getElementById('signup-password-confirm').value;

            if (!name || !password) return alert('ì´ë¦„ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            if (password !== confirmPw) return alert('ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
            if (password.length < 4) return alert('ë¹„ë°€ë²ˆí˜¸ëŠ” 4ìë¦¬ ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');

            showLoading(true);
            try {
                const data = await apiCall(API_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'signup', name, team, position, password })
                });

                if (data.status === 'success') {
                    showToast('ê°€ì… ì™„ë£Œ! ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.', 'ğŸ‰');
                    // Pre-fill login fields
                    document.getElementById('login-name').value = name;
                    document.getElementById('login-team').value = team;
                    document.getElementById('login-password').value = '';
                    toggleScreen('login-screen');
                } else {
                    alert('ê°€ì… ì‹¤íŒ¨: ' + (data.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                }
            } catch (e) {
                console.error(e);
                alert('ê°€ì… ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n' + e.message);
            } finally {
                showLoading(false);
            }
        }

        function logout() {
            currentUser = null;
            selectedUserIds.clear();
            manualEntries = [];
            toggleScreen('login-screen');
            showToast('ë¡œê·¸ì•„ì›ƒ ì™„ë£Œ', 'ğŸ‘‹');
        }

        // --- ADMIN / CSV LOGIC ---
        function toggleAdmin(show) {
            const modal = document.getElementById('admin-modal');
            if (show) modal.classList.remove('hidden');
            else modal.classList.add('hidden');
        }

        function downloadTemplate() {
            const csvContent = "data:text/csv;charset=utf-8,\uFEFFì´ë¦„,ìƒë…„ì›”ì¼,ì„±ë³„,ì—°ë½ì²˜,ì¥ì• ìœ í˜•,ì¥ì• ì •ë„\ní™ê¸¸ë™,1990-01-01,ë‚¨,010-0000-0000,ì§€ì²´,ê²½ì¦";
            const link = document.createElement("a");
            link.setAttribute("href", encodeURI(csvContent));
            link.setAttribute("download", "user_template.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function processCSV() {
            const file = document.getElementById('csv-file').files[0];
            if (!file) return alert("íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
            const reader = new FileReader();
            reader.onload = async (e) => {
                const rows = e.target.result.split("\n");
                const users = [];
                for (let i = 1; i < rows.length; i++) {
                    const row = rows[i].split(",");
                    if (row.length >= 2) {
                        const clean = row.map(c => c.trim().replace('\r', ''));
                        if (clean[0]) users.push(clean);
                    }
                }
                if (!users.length) return alert("ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
                if (confirm(`${users.length}ëª…ì˜ ì´ìš©ìë¥¼ ì¶”ê°€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                    showLoading(true);
                    try {
                        await apiCall(API_URL, { method: 'POST', body: JSON.stringify({ action: 'upload_users', users }) });
                        showToast(`${users.length}ëª… ì—…ë¡œë“œ ì™„ë£Œ`, 'ğŸ“¤');
                        toggleAdmin(false);
                    } catch (e) { alert("ì—…ë¡œë“œ ì‹¤íŒ¨: " + e.message); }
                    finally { showLoading(false); }
                }
            };
            reader.readAsText(file);
        }

        // --- DASHBOARD LOGIC ---
        function renderPrograms(programs) {
            const select = document.getElementById('program-select');
            select.innerHTML = '<option value="">í”„ë¡œê·¸ë¨ì„ ì„ íƒí•˜ì„¸ìš”</option>';
            programs.forEach(p => {
                select.innerHTML += `<option value="${p.id}" data-type="${p.type}">${p.category} > ${p.name}</option>`;
            });
        }

        function loadProgramData() {
            const select = document.getElementById('program-select');
            if (select.selectedIndex <= 0) return;
            const type = select.options[select.selectedIndex].getAttribute('data-type');
            switchTab(type === 'individual' ? 'individual' : 'attendance');
        }

        function renderUserList(users) {
            const container = document.getElementById('user-list');
            container.innerHTML = '';
            if (users.length === 0) {
                container.innerHTML = '<p class="text-center text-sm text-gray-400 py-4">ë“±ë¡ëœ ì´ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }
            users.forEach(u => {
                const checked = selectedUserIds.has(u.id) ? 'checked' : '';
                container.innerHTML += `
                    <label class="flex items-center p-3 glass rounded-xl cursor-pointer active:bg-blue-50/30 transition">
                        <input type="checkbox" value="${u.id}" ${checked} onchange="toggleUser('${u.id}')" class="w-5 h-5 text-blue-500 rounded border-gray-300 focus:ring-blue-400">
                        <span class="ml-3 flex-1 font-medium text-gray-700">${u.name}</span>
                        <span class="text-xs text-gray-400 bg-white/60 px-2 py-0.5 rounded-full">${u.info}</span>
                    </label>`;
            });
        }

        function filterUsers() {
            const q = document.getElementById('user-search').value.toLowerCase();
            renderUserList(allUsers.filter(u => u.name.toLowerCase().includes(q)));
        }

        function toggleUser(id) {
            if (selectedUserIds.has(id)) selectedUserIds.delete(id);
            else selectedUserIds.add(id);
        }

        // --- INDIVIDUAL ENTRY ---
        function addManualEntry() {
            const name = document.getElementById('manual-name').value.trim();
            const note = document.getElementById('manual-note').value.trim();
            if (!name) return alert('ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.');
            manualEntries.push({ name, note, id: 'M_' + Date.now() });
            renderManualList();
            document.getElementById('manual-name').value = '';
            document.getElementById('manual-note').value = '';
        }

        function renderManualList() {
            const c = document.getElementById('manual-list');
            c.innerHTML = '';
            manualEntries.forEach((e, i) => {
                c.innerHTML += `
                    <div class="flex justify-between items-center p-3 glass rounded-xl">
                        <div><div class="font-medium text-gray-800">${e.name}</div><div class="text-xs text-gray-500">${e.note || '-'}</div></div>
                        <button onclick="removeManualEntry(${i})" class="text-red-400 hover:text-red-600 text-sm btn-glass">ì‚­ì œ</button>
                    </div>`;
            });
        }

        function removeManualEntry(i) { manualEntries.splice(i, 1); renderManualList(); }

        // --- SUBMISSION ---
        async function submitData() {
            const programId = document.getElementById('program-select').value;
            const date = document.getElementById('record-date').value;
            if (!programId) return alert('í”„ë¡œê·¸ë¨ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');

            const entries = [];
            selectedUserIds.forEach(id => {
                const user = allUsers.find(u => u.id === id);
                if (user) entries.push({ user_name: user.name, status: 'ì¶œì„', note: '' });
            });
            manualEntries.forEach(m => entries.push({ user_name: m.name, status: 'ì¶œì„', note: m.note }));

            if (!entries.length) return alert('ì…ë ¥ëœ ì‹¤ì ì´ ì—†ìŠµë‹ˆë‹¤.');
            if (!confirm(`${entries.length}ê±´ì˜ ì‹¤ì ì„ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

            showLoading(true);
            try {
                const prog = currentUser.programs.find(p => p.id === programId);
                if (!prog) return alert('ì„ íƒí•œ í”„ë¡œê·¸ë¨ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                await apiCall(API_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'submit_log', token: currentUser.token, date,
                        program_name: prog.name,
                        manager_name: currentUser.name, entries
                    })
                });
                showToast(`${entries.length}ê±´ ì €ì¥ ì™„ë£Œ`, 'âœ…');
                selectedUserIds.clear();
                manualEntries = [];
                renderUserList(allUsers);
                renderManualList();
            } catch (e) { alert('ì €ì¥ ì‹¤íŒ¨: ' + e.message); }
            finally { showLoading(false); }
        }

        // --- UTILS ---
        function switchTab(tab) {
            const views = ['attendance', 'individual'];
            views.forEach(v => {
                document.getElementById('view-' + v).classList.toggle('hidden', v !== tab);
                const btn = document.getElementById('tab-' + v);
                if (v === tab) {
                    btn.classList.add('bg-white', 'shadow-sm', 'text-blue-600');
                    btn.classList.remove('text-gray-500');
                } else {
                    btn.classList.remove('bg-white', 'shadow-sm', 'text-blue-600');
                    btn.classList.add('text-gray-500');
                }
            });
        }

        function toggleScreen(screenId) {
            ['login-screen', 'signup-screen', 'dashboard-screen'].forEach(s => {
                document.getElementById(s).classList.toggle('hidden', s !== screenId);
            });
        }

        function showLoading(show) {
            document.getElementById('loading').classList.toggle('hidden', !show);
        }
    </script>
</body>

</html>